#!/usr/bin/env python3
"""
æµ‹è¯•Qwen3 TTSé•¿æ–‡æœ¬å¤„ç†
éªŒè¯TextChunkeråˆ†ç‰‡é€»è¾‘å’ŒAPIè°ƒç”¨
"""

import re
import requests
import json
import base64
from typing import List

# APIé…ç½®
API_KEY = "sk-724a0524ffd94522a70c6869d11e002c"
API_URL = "https://dashscope.aliyuncs.com/api/v1/services/aigc/multimodal-generation/generation"

# æµ‹è¯•æ–‡æœ¬ï¼ˆç”¨æˆ·æä¾›çš„å°è¯´å†…å®¹ï¼‰
TEST_TEXT = """ç¬¬5081ç« è‡ªæ€§æœ¬è¶³
ã€€ã€€è€Œå¤å¸ç›¯ç€æ´›å°˜çš„ç å­ï¼Œå¥½çœ‹çš„ç å­ï¼Œå’Œä¸€é¢—é‡‘ç å­ï¼
ã€€ã€€"æ—¶é—´ä¸€å¤©ä¸€å¤©è¿‡å»ï¼Œé‡‘ç å­å’Œè¿™é¢—ç å­ï¼Œä¾ç„¶æ²¡æœ‰è¢«å–å‡ºå»ï¼"
ã€€ã€€"è¿™é¢—ç å­æ¯å¤©éƒ½åœ¨éš¾è¿‡ä¹‹ä¸­æ¸¡è¿‡ï¼Œæ¯å¤©éƒ½åœ¨è‡ªæˆ‘æ€€ç–‘ä¹‹ä¸­æ¸¡è¿‡ï¼"
ã€€ã€€"ç›´åˆ°æœ‰ä¸€å¤©ï¼"æ´›å°˜åˆç»§ç»­è¯´é“ã€‚
ã€€ã€€"å¸ˆå¼Ÿï¼Œç­‰ä¸€ä¸‹ï¼Œæˆ‘ç¿»ä¸‹é±¼ï¼"å¤å¸å¼€å£é—´ï¼Œç¬é—´å‡ºç°åœ¨ä¸è¿œå¤„ï¼Œå¼€å§‹ç¿»é±¼äº†ã€‚
ã€€ã€€è€Œåœ¨è¡€æ± é‚£è¾¹ï¼Œå·«ç‹åœ¨è¿™ä¸€åˆ»ï¼ŒèƒŒéƒ¨çš„è¡€è‚‰å·²ç»åœ¨å†’çƒŸäº†ï¼ŒåŒæ—¶æ•´ä¸ªè¡€æ± å·²ç»æ²¸è…¾èµ·æ¥äº†ï¼Œç”šè‡³å¼€å§‹å¹²æ¶¸äº†ã€‚
ã€€ã€€å¥¹ä¸€ç›´åœ¨å“€åšï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œå¥¹ä»€ä¹ˆä¹Ÿåšä¸äº†ï¼
ã€€ã€€è€Œç¿»å®Œé±¼ï¼Œå¤å¸åˆåäº†å›æ¥ã€‚
ã€€ã€€"é‡‘ç å­ä¹Ÿè¢«ä¹°èµ°äº†ï¼Ÿ"å¤å¸å¼€å£é“ã€‚
ã€€ã€€"å¯¹ï¼Œå…¶å®é‚£ä¸ªäººï¼Œçœ‹ä¸Šäº†è¿™é¢—å¥½çœ‹çš„ç å­ï¼Œå·²ç»ä»˜å®Œé’±äº†ï¼Œä½†æ˜¯æœ€ç»ˆï¼Œä»–è¿˜æ˜¯æ”¾å¼ƒäº†è¿™é¢—ç å­ï¼Œé€‰æ‹©äº†é‡‘ç å­ï¼"æ´›å°˜è¯´ç€ï¼Œæ‰‹ä¸­åªå‰©ä¸‹æœ€åä¸€é¢—ç å­äº†ã€‚
ã€€ã€€"å› ä¸ºè¿™é¢—ç å­éœ²é™·äº†ï¼Œå®ƒå˜æˆäº†é‡‘ç å­ï¼Œä½†æ˜¯ä¹°ä¸»æ‹¿åœ¨æ‰‹ä¸­çš„æ—¶å€™ï¼Œæ‰å‘ç°ï¼Œä¸æ˜¯çœŸæ­£çš„é‡‘ç å­ã€‚"
ã€€ã€€"è¿™é¢—ç å­ï¼Œä¸€ç›´æ€€ç–‘è‡ªå·±ï¼Œä¸€ç›´å¾ˆéš¾å—ï¼"
ã€€ã€€"æ—¶é—´ä¸å†æ˜¯ä¸€å¤©å¤©çš„è¿‡å»ï¼Œè€Œæ˜¯ä¸€å¹´å¹´è¿‡å»äº†ã€‚"
ã€€ã€€"å®ƒä¸å†å˜æˆå…¶ä»–çš„é¢œè‰²ï¼Œå˜æˆå…¶ä»–çš„ç å­ï¼Œè€Œæ˜¯å›åˆ°äº†å®ƒä¸€å¼€å§‹çš„æ¨¡æ ·ã€‚"
ã€€ã€€"ç›´åˆ°ä¸€ä¸ªå¤§é›ªå¤œï¼Œæœ‰ä¸€ä¸ªå¥³å­æ¥äº†ï¼Œå¥¹å¾ˆç¾ï¼Œååˆ†çš„é—ªè€€ï¼Œç…§äº®äº†å¤©åœ°é—´ã€‚"
ã€€ã€€"å¥¹æœ€ç»ˆï¼Œçœ‹ä¸Šäº†è¿™é¢—ç å­ï¼"
ã€€ã€€"å°†è¿™é¢—ç å­ï¼Œæ§åœ¨æ‰‹æŒä¹‹ä¸­ï¼Œå› ä¸ºè¿™é¢—ç å­æ˜¯ä¸€é¢—äº”å½©ç¥çŸ³ç å­ï¼"
ã€€ã€€"å¥¹å¸¦èµ°äº†å®ƒï¼"æ´›å°˜è¯´é“è¿™é‡Œï¼Œåœä¸‹äº†ã€‚
ã€€ã€€"è¿™å’Œçˆ±æƒ…ï¼Œæœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ"å¤©ç«è¹™çœ‰é“ã€‚
ã€€ã€€ä¸æ˜¯è®²çˆ±æƒ…å—ï¼Ÿ
ã€€ã€€"æ€ä¹ˆè®²èµ·ç å­äº†ï¼Ÿ"
ã€€ã€€"çˆ±æƒ…ï¼Œæœ‰ä¸€è§é’Ÿæƒ…ï¼Œæœ‰ä½ å–œæ¬¢å¯¹æ–¹ï¼Œä½†æ˜¯å¯¹æ–¹å´ä¸å–œæ¬¢ä½ ï¼"
ã€€ã€€"æœ‰åŒæ–¹å–œæ¬¢ï¼Œä½†æ˜¯å¯¹æ–¹æœ€ç»ˆå´èƒŒå›äº†ä½ ï¼Œæ”¾å¼ƒäº†ä½ ï¼Œæ¢äº†äººã€‚"æ´›å°˜å¹³é™å›ç­”é“ã€‚
ã€€ã€€å°±å’Œè¿™é¢—ç å­ä¸€æ ·ï¼Œå®ƒå–œæ¬¢çš„äººï¼Œæ²¡æœ‰å¸¦èµ°å®ƒï¼Œç”šè‡³é€‰æ‹©äº†ä¸€é¢—çŸ³ç å­ï¼Œæ¯”å®ƒå·®å¤ªå¤šäº†ã€‚
ã€€ã€€ä¹Ÿæœ‰äººä¹°ä¸‹äº†å®ƒï¼Œä½†æ˜¯æœ€ç»ˆæ²¡æœ‰ç»å—ä½é‡‘ç å­çš„è¯±æƒ‘ï¼ŒèƒŒå›äº†å®ƒï¼
ã€€ã€€æ›´æœ‰çœ‹éƒ½ä¸çœ‹å®ƒä¸€çœ¼çš„äººï¼Œç›´æ¥ä¹°èµ°äº†å…¶ä»–çš„ç å­ï¼
ã€€ã€€"è¿™ä¸ªå°±æ˜¯çˆ±æƒ…ï¼Ÿ"å¤å¸é—®é“ã€‚
ã€€ã€€"è¿™ä»£è¡¨ä¸äº†çˆ±æƒ…ï¼Œåªæ˜¯ä»£è¡¨äº†ä¸€ç§çˆ±æƒ…çš„ç°è±¡ï¼"æ´›å°˜æ‘‡æ‘‡å¤´ã€‚
ã€€ã€€"ä½ åœ¨æœŸå¾…çˆ±æƒ…ï¼"æ´›å°˜å¼€å£é“ã€‚
ã€€ã€€"å¸ˆå…„æˆ‘åªæ˜¯æƒ³ä½“éªŒä¸€ä¸‹ã€‚"
ã€€ã€€"ä½†æ˜¯å¯»æ‰¾ä¸åˆ°ï¼Œå¸ˆå¼Ÿï¼Œæˆ‘å°±æ˜¯é‚£é¢—äº”å½©ç¥çŸ³çš„ç å­ï¼Œå¯¹å—ï¼Ÿ"
ã€€ã€€"äººäººéƒ½æ˜¯é‚£é¢—äº”å½©ç¥çŸ³çš„ç å­ï¼Œæ¸´æœ›çˆ±æƒ…ï¼Œå¯»æ‰¾çˆ±æƒ…ï¼Œä½†æ˜¯åˆè½é€‰ï¼Œç”šè‡³ä¸ºäº†çˆ±æƒ…ï¼Œå˜æˆäº†å…¶ä»–çš„æ¨¡æ ·ã€‚"æ´›å°˜å†æ¬¡å¼€å£é“ã€‚
ã€€ã€€"ç»†è¯´ï¼"å¤å¸çœ‹ç€æ´›å°˜ï¼Œè®¤çœŸé—®é“ã€‚
ã€€ã€€"ç¬¬ä¸€ä¸ªäººæ²¡æœ‰é€‰æ‹©äº”å½©ç¥çŸ³ç å­ï¼Œé€‰æ‹©äº†çŸ³ç å­ï¼Œä»£è¡¨äº†çŸ³ç å­ä¸å¥½å—ï¼Ÿ"
ã€€ã€€"ä¸ï¼Œåªæ˜¯é‚£ä¸ªäººä¹°é¢—çŸ³ç å­ï¼Œæ˜¯å› ä¸ºå®¶é‡Œæœ‰ç”¨ï¼Œäº”å½©ç¥çŸ³è™½å¥½ï¼Œä½†æ˜¯ä¸åˆé€‚ã€‚"æ´›å°˜å¼€å£é“ã€‚
ã€€ã€€"ç¬¬äºŒä¸ªï¼Œç¬¬ä¸‰ä¸ªï¼Œé€‰æ‹©å…¶ä»–ç å­ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªé“ç†ã€‚"
ã€€ã€€"å“ªæ€•æ˜¯å·²ç»ä¹°ä¸‹äº”å½©ç¥çŸ³é‚£ä¸ªäººï¼Œæœ€ç»ˆæ¢äº†é‡‘ç å­ï¼Œé“ç†ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œè¿™ä¸ªä¸–ç•Œï¼Œä½ è¦æ‰¾åˆ°å¦å¤–ä¸€åŠï¼Œå¾ˆéš¾ï¼"
ã€€ã€€"ä½†æ˜¯ï¼Œé‚£ä¸ä»£è¡¨ç€ï¼Œä½ è‡ªèº«æ˜¯ä¸å¥½çš„ï¼Œä¹Ÿä¸ä»£è¡¨ç€ï¼Œä½ æœ€ç»ˆï¼Œä¼šæ²¡æœ‰é€‰æ‹©ï¼"
ã€€ã€€"è¿™å°±æ˜¯çˆ±æƒ…ï¼Ÿ"å¤å¸å†æ¬¡é—®é“ã€‚
ã€€ã€€"ä¸ï¼Œè¿™åªæ˜¯æ•…äº‹çš„ç‰ˆæœ¬ä¹‹ä¸€ï¼Œè¿˜æœ‰å¦å¤–ä¸€ä¸ªç‰ˆæœ¬ï¼Œåˆèµ·æ¥ï¼Œæ‰æ˜¯çˆ±æƒ…ï¼"æ´›å°˜ç»§ç»­è¯´é“ã€‚
ã€€ã€€è€Œå¦å¤–ä¸€è¾¹çš„è¡€æ± å†…ï¼Œå·«ç‹ç–¼çš„ä¸æ–­åœ¨èœ·ç¼©å’Œé¢¤æŠ–äº†ï¼Œå¤ªçƒ­çƒˆäº†ï¼Œè¿™çƒˆç‚çƒ­çƒˆçš„è®©å¥¹å‡ ä¹è¦å—ä¸äº†äº†ã€‚
ã€€ã€€ä¸€è¾¹èŠçˆ±æƒ…ï¼Œä¸€è¾¹å´æ˜¯åœ¨ç—›è‹¦çš„ç…ç†¬ç€ã€‚
ã€€ã€€è¿æ­»ï¼Œéƒ½æ­»ä¸äº†ï¼
ã€€ã€€"ä½ è¯´å¦å¤–ä¸€ä¸ªç‰ˆæœ¬ï¼"
ã€€ã€€"å¦‚æœè¿™é¢—äº”å½©ç¥çŸ³çš„ç å­ï¼Œä¸€å¼€å§‹å°±çŸ¥é“è‡ªå·±æ˜¯äº”å½©ç¥çŸ³çš„ç å­ï¼Œé‚£ç»“å±€æ˜¯æ€æ ·çš„ï¼Ÿ"æ´›å°˜å¿½ç„¶é—®é“ã€‚
ã€€ã€€"ä¸€å¼€å§‹ï¼Œå®ƒå°±çŸ¥é“è‡ªå·±çš„ä¼˜ç‚¹ï¼Œæ‰€ä»¥ï¼Œå½“ç¬¬ä¸€ä¸ªäººæ¥çš„æ—¶å€™ï¼Œå®ƒä¸ä¼šçœ‹ä¸€çœ¼é‚£ä¸ªäººï¼Œçˆ±ä¹°çŸ³ç å­ï¼Œå°±ä¹°çŸ³ç å­ï¼"
ã€€ã€€"ç¬¬äºŒä¸ªï¼Œç¬¬ä¸‰ä¸ªï¼Œç¬¬å››ä¸ªæ¥äººï¼Œäº”å½©ç¥çŸ³ä¹Ÿä¸ä¼šåœ¨æ„ã€‚"
ã€€ã€€"å®ƒæ¯å¤©éƒ½ä¼šå¼€å¼€å¿ƒå¿ƒçš„ï¼Œæ¯å¤©éƒ½åšç€è‡ªå·±ï¼Œå¹¶ä¸”å’Œå…¶ä»–çš„ç å­æˆä¸ºå¥½æœ‹å‹ï¼Œå½“å®ƒä»¬è¢«ä¹°èµ°çš„æ—¶å€™ï¼Œå®ƒä¼šå¼€å¿ƒçš„ç¥ç¦å®ƒä»¬ï¼"æ´›å°˜åˆè¯´é“ã€‚
ã€€ã€€"å› ä¸ºå®ƒçŸ¥é“è‡ªå·±çš„ä»·å€¼ï¼Œå®ƒä¸å†æœŸå¾…ï¼Œå®ƒå¾ˆçˆ±å®ƒè‡ªå·±ï¼Œå®ƒè®¤ä¸ºè‡ªå·±å€¼å¾—ï¼"
ã€€ã€€"å¦‚æœï¼Œæœ€åé‚£ä¸ªå¥³å­æ²¡æœ‰å‡ºç°å‘¢ï¼Ÿ"å¤å¸åˆé—®é“ã€‚
ã€€ã€€"é‚£å°±ä¸å‡ºç°ï¼Œå®ƒæœ¬èº«å°±æ˜¯å®Œæ•´çš„ï¼Œå®ƒå‘å†…æ±‚ï¼Œå®ƒä¸éœ€è¦å‘å¤–æ±‚ï¼Œä¸éœ€è¦åˆ«äººæ¥è¯æ˜å®ƒçš„ä»·å€¼ï¼Œå®ƒå–œæ¬¢è‡ªå·±çš„å­¤ç‹¬ï¼Œäº«å—è‡ªèº«ï¼"æ´›å°˜åˆå¼€å£é“ã€‚
ã€€ã€€"å®ƒæ²¡æœ‰æƒ…æ„Ÿä¸Šçš„éœ€æ±‚ï¼"æ´›å°˜è¯´çš„å¾ˆç›´æ¥äº†ã€‚
ã€€ã€€"æ‰€ä»¥ï¼Ÿ"å¤©ç«ä¹Ÿå¥½å¥‡çš„é—®é“ï¼Œè¿™ä¸ªè§‚ç‚¹å¾ˆæ–°å¥‡ã€‚
ã€€ã€€å› ä¸ºä»–å¯¹çˆ±æƒ…ä¹Ÿä¸æ˜¯å¾ˆç†è§£ã€‚
ã€€ã€€"å½“ç å­ï¼Œå¼€å§‹çˆ±è‡ªå·±çš„æ—¶å€™ï¼Œçˆ±æƒ…å°±æ¥äº†ï¼"
ã€€ã€€"äººæœ¬èº«å°±æ˜¯å®Œæ•´çš„ï¼Œä½ ä¸éœ€è¦çˆ±æƒ…ï¼"æ´›å°˜çœ‹ç€å¤å¸åˆä¸€æ¬¡å¼€å£é“ã€‚
ã€€ã€€ä½™ä¸‹çš„è¯ï¼Œæ´›å°˜æ²¡æœ‰è¯´ï¼Œçˆ±æƒ…ä»å¼€å§‹çš„ç¾å¥½ï¼Œåˆ°æœ€åçš„é…¸æ¶©ï¼Œå†åˆ°æœ€åçš„èµ°æ•£ã€‚
ã€€ã€€å…¶å®éƒ½æ˜¯åŒæ–¹çš„éœ€æ±‚çš„å˜åŒ–ï¼ŒåŒæ–¹éƒ½æƒ³æ‰¾ä¸ªäººæ¥æ»¡è¶³è‡ªèº«çš„ä¸è¶³ï¼Œæ»¡è¶³è‡ªèº«çš„éœ€æ±‚ã€‚
ã€€ã€€éœ€æ±‚è¢«æ»¡è¶³äº†ï¼Œå°±è§‰å¾—ç”œèœœï¼Œæ²¡æœ‰è¢«æ»¡è¶³ï¼Œå°±è§‰å¾—ä¸è¢«çˆ±äº†ã€‚
ã€€ã€€ä½†æ˜¯è¿™éƒ½æ˜¯å‘å¤–æ±‚çš„ä¸€ç§æ–¹å¼ã€‚
ã€€ã€€çœŸæ­£çš„çˆ±æƒ…ï¼Œæ˜¯å½¼æ­¤éƒ½èƒ½å¤Ÿæ»¡è¶³è‡ªèº«çš„éœ€æ±‚ï¼Œä¹Ÿæ„¿æ„å»åˆ†äº«å‡ºå»ã€‚
ã€€ã€€æœ‰ï¼Œæ˜¯é”¦ä¸Šæ·»èŠ±ï¼
ã€€ã€€æ²¡æœ‰ï¼Œä¹Ÿä¸å½±å“äººç”Ÿï¼
ã€€ã€€"å‘å†…æ±‚ï¼Œçˆ±è‡ªå·±ï¼"
ã€€ã€€"è‡ªæ€§æœ¬è¶³ï¼"æ´›å°˜çœ‹ç€å¤å¸ã€‚
ã€€ã€€è€Œå¤å¸åœ¨è¿™ä¸€åˆ»ï¼Œå†…å¿ƒæ·±å¤„ï¼Œæœ‰ä¸ªåœ°æ–¹ç¬é—´åœ†æ»¡èµ·æ¥äº†ã€‚
ã€€ã€€ä»–æ˜¯è®¤çœŸé—®æ´›å°˜çš„ï¼Œè€Œä¹Ÿå¾—åˆ°äº†ç­”æ¡ˆï¼
ã€€ã€€æ‰€ä»¥ï¼Œåœ¨ç–‘æƒ‘ç‚¹ä¸Šï¼Œä»–è§£å¼€äº†ã€‚
ã€€ã€€å¤ªå­çˆ·åˆ™æ˜¯ä¸€è„¸çš„æƒŠè®¶ä¸è®¤çœŸã€‚
ã€€ã€€å› ä¸ºä»–è€çˆ¹æŠŠçˆ±æƒ…çœ‹çš„å¾ˆé€å½»ã€‚
ã€€ã€€çˆ±æƒ…ä¸å¿…å»å¼ºæ±‚ä¸è¿½å¯»ï¼Œå¼ºæ±‚ä¸è¿½å¯»çš„ï¼ŒåŠ¿å¿…ä¼šå‹æŠ‘ä¸€éƒ¨åˆ†è‡ªå·±ï¼Œåˆ°æ—¶å€™æ”¹å˜å¾—æ¥çš„ï¼Œå§‹ç»ˆå¾—ä¸å¿å¤±ã€‚
ã€€ã€€å¤§èƒ†åšè‡ªå·±ï¼Œçˆ±æƒ…è‡ªä¼šæ¥ã€‚
ã€€ã€€å› ä¸ºè¿™ä¸ªä¸–ç•Œï¼Œä¸æ˜¯æ¯ä¸ªäººéƒ½æ˜¯è¯†è´§çš„ï¼Œä¹Ÿæ²¡å¿…è¦è®©æ¯ä¸€ä¸ªäººå–œæ¬¢ã€‚
ã€€ã€€å¤ªå­çˆ·ç¢ç£¨ç€ï¼Œè€Œå¤å¸æ²‰æ€è®¸ä¹…åï¼Œä»–æ˜¯çœŸçš„ä¸å†æ‰§ç€æ²¡æœ‰ä½“ä¼šè¿‡çˆ±æƒ…äº†ã€‚
ã€€ã€€å°±åœ¨åˆšåˆšæ´›å°˜è®²çš„é‚£ä¸ªæ•…äº‹é‡Œï¼Œä»–ä¼¼ä¹å·²ç»ä½“éªŒè¿‡äº†çˆ±æƒ…ã€‚
ã€€ã€€"æˆ‘å†å»ç¿»ä¸‹é±¼ï¼"å¤å¸å¤§ç¬‘é“ï¼Œæ€æ°”çš„èµ°å‘äº†é‚£çƒ¤é±¼ï¼
ã€€ã€€è¿™ä¸€æ¬¡ï¼Œä»–ä¸å†ç•™æ‰‹äº†ã€‚
ã€€ã€€å¾ˆå¤šå¹´å‰ï¼Œæœ‰ä¸ªå°‘å¥³ï¼Œé—¯è¿›äº†ä»–çš„å›½åº¦ï¼Œé—¯è¿›äº†ä»–çš„ä¸–ç•Œâ€¦â€¦"""


def smart_chunk(text: str, max_length: int = 600) -> List[str]:
    """
    æ™ºèƒ½æ–‡æœ¬åˆ†ç‰‡ï¼ˆæ¨¡æ‹ŸKotlinçš„TextChunker.smartChunkï¼‰
    ä¿®å¤åçš„ç‰ˆæœ¬ï¼šæ­£ç¡®è®¡ç®—ç©ºæ ¼é•¿åº¦
    """
    if len(text) <= max_length:
        return [text]
    
    # æŒ‰å¥å­è¾¹ç•Œåˆ†å‰²ï¼ˆä¿ç•™æ ‡ç‚¹ï¼‰
    sentence_regex = r'(?<=[ã€‚ï¼Ÿï¼â€¦â€¦?!\n])'
    sentences = [s.strip() for s in re.split(sentence_regex, text) if s.strip()]
    
    chunks = []
    current_chunk = []
    current_length = 0
    
    for sentence in sentences:
        # è®¡ç®—æ·»åŠ è¿™ä¸ªå¥å­åçš„æ€»é•¿åº¦ï¼ˆåŒ…æ‹¬ç©ºæ ¼ï¼‰
        space_length = 1 if current_chunk else 0
        total_length = current_length + space_length + len(sentence)
        
        if total_length > max_length:
            # ä¿å­˜å½“å‰chunk
            if current_chunk:
                chunks.append(' '.join(current_chunk))
                current_chunk = []
                current_length = 0
            
            # å¤„ç†è¶…é•¿å¥å­ï¼ˆç¡¬åˆ‡åˆ†ï¼‰
            if len(sentence) > max_length:
                # ç›´æ¥æŒ‰max_lengthåˆ‡å‰²
                for i in range(0, len(sentence), max_length):
                    chunk_part = sentence[i:i + max_length]
                    chunks.append(chunk_part)
            else:
                current_chunk = [sentence]
                current_length = len(sentence)
        else:
            # æ·»åŠ å¥å­
            current_chunk.append(sentence)
            current_length = total_length
    
    # ä¿å­˜æœ€åçš„chunk
    if current_chunk:
        chunks.append(' '.join(current_chunk))
    
    return chunks


def call_qwen3_tts(text: str, voice: str = "Cherry", language: str = "Chinese") -> dict:
    """
    è°ƒç”¨Qwen3 TTS APIï¼ˆéæµå¼ï¼‰
    """
    headers = {
        "Content-Type": "application/json",
        "Authorization": f"Bearer {API_KEY}"
    }
    
    payload = {
        "model": "qwen3-tts-flash",
        "input": {
            "text": text,
            "voice": voice,
            "language_type": language
        }
    }
    
    print(f"\nğŸ“¤ è°ƒç”¨API... (æ–‡æœ¬é•¿åº¦: {len(text)} å­—ç¬¦)")
    print(f"   è¯·æ±‚ä½“: {json.dumps(payload, ensure_ascii=False, indent=2)}")
    
    try:
        response = requests.post(API_URL, headers=headers, json=payload, timeout=30)
        
        print(f"   çŠ¶æ€ç : {response.status_code}")
        
        if response.status_code == 200:
            result = response.json()
            audio_url = result.get('output', {}).get('audio', {}).get('url', '')
            print(f"   âœ… æˆåŠŸï¼éŸ³é¢‘URL: {audio_url[:80]}...")
            return {"success": True, "url": audio_url}
        else:
            error_data = response.json()
            print(f"   âŒ å¤±è´¥ï¼é”™è¯¯: {error_data}")
            return {"success": False, "error": error_data}
            
    except Exception as e:
        print(f"   âŒ å¼‚å¸¸: {str(e)}")
        return {"success": False, "error": str(e)}


def test_long_text_processing():
    """
    æµ‹è¯•é•¿æ–‡æœ¬å¤„ç†æµç¨‹
    """
    print("=" * 80)
    print("ğŸ§ª Qwen3 TTS é•¿æ–‡æœ¬å¤„ç†æµ‹è¯•")
    print("=" * 80)
    
    # 1. æ˜¾ç¤ºåŸå§‹æ–‡æœ¬ä¿¡æ¯
    print(f"\nğŸ“ åŸå§‹æ–‡æœ¬ä¿¡æ¯:")
    print(f"   æ€»å­—ç¬¦æ•°: {len(TEST_TEXT)}")
    print(f"   å‰100å­—ç¬¦: {TEST_TEXT[:100]}...")
    
    # 2. æ‰§è¡Œåˆ†ç‰‡
    print(f"\nâœ‚ï¸  æ™ºèƒ½åˆ†ç‰‡å¤„ç†:")
    chunks = smart_chunk(TEST_TEXT, max_length=600)
    print(f"   åˆ†ç‰‡æ•°é‡: {len(chunks)}")
    
    # 3. éªŒè¯æ¯ä¸ªåˆ†ç‰‡é•¿åº¦
    print(f"\nğŸ” åˆ†ç‰‡é•¿åº¦éªŒè¯:")
    all_valid = True
    for i, chunk in enumerate(chunks, 1):
        status = "âœ…" if len(chunk) <= 600 else "âŒ"
        print(f"   ç‰‡æ®µ{i}: {len(chunk)} å­—ç¬¦ {status}")
        if len(chunk) > 600:
            all_valid = False
            print(f"      âš ï¸  è¶…å‡ºé™åˆ¶ï¼å‰50å­—: {chunk[:50]}...")
    
    if all_valid:
        print(f"\nâœ… æ‰€æœ‰åˆ†ç‰‡é•¿åº¦å‡<=600å­—ç¬¦")
    else:
        print(f"\nâŒ å­˜åœ¨è¶…é•¿åˆ†ç‰‡ï¼")
        return
    
    # 4. æµ‹è¯•APIè°ƒç”¨ï¼ˆåªè°ƒç”¨ç¬¬ä¸€ç‰‡ï¼Œé¿å…æ¶ˆè€—é…é¢ï¼‰
    print(f"\nğŸš€ æµ‹è¯•APIè°ƒç”¨ï¼ˆä»…ç¬¬1ç‰‡ï¼‰:")
    print(f"   æ–‡æœ¬å†…å®¹: {chunks[0][:100]}...")
    
    result = call_qwen3_tts(chunks[0], voice="Cherry", language="Chinese")
    
    # 5. æ€»ç»“
    print(f"\n" + "=" * 80)
    print(f"ğŸ“Š æµ‹è¯•æ€»ç»“:")
    print(f"   åŸæ–‡é•¿åº¦: {len(TEST_TEXT)} å­—ç¬¦")
    print(f"   åˆ†ç‰‡æ•°é‡: {len(chunks)} ç‰‡")
    print(f"   å¹³å‡ç‰‡é•¿: {sum(len(c) for c in chunks) // len(chunks)} å­—ç¬¦")
    print(f"   æœ€é•¿ç‰‡æ®µ: {max(len(c) for c in chunks)} å­—ç¬¦")
    print(f"   æœ€çŸ­ç‰‡æ®µ: {min(len(c) for c in chunks)} å­—ç¬¦")
    print(f"   APIè°ƒç”¨: {'âœ… æˆåŠŸ' if result.get('success') else 'âŒ å¤±è´¥'}")
    print("=" * 80)
    
    # 6. å¦‚æœAPIè°ƒç”¨æˆåŠŸï¼Œæ˜¾ç¤ºæ‰€æœ‰åˆ†ç‰‡çš„é¢„ä¼°å¤„ç†æ—¶é—´
    if result.get('success'):
        print(f"\nâ±ï¸  å®Œæ•´å¤„ç†æ—¶é—´é¢„ä¼°:")
        print(f"   æ¯ç‰‡è€—æ—¶: çº¦3-5ç§’")
        print(f"   ç‰‡æ®µé—´å»¶è¿Ÿ: 0.5ç§’")
        print(f"   æ€»è€—æ—¶: çº¦{len(chunks) * 4 + (len(chunks) - 1) * 0.5:.1f}ç§’")
        print(f"   åˆå¹¶éŸ³é¢‘: çº¦1ç§’")
        print(f"   æ€»è®¡: çº¦{len(chunks) * 4 + (len(chunks) - 1) * 0.5 + 1:.1f}ç§’")


def test_stream_api_demo():
    """
    æ¼”ç¤ºæµå¼APIè°ƒç”¨æ–¹å¼ï¼ˆéœ€è¦DashScope SDKï¼‰
    """
    print("\n" + "=" * 80)
    print("ğŸ“˜ æµå¼APIè°ƒç”¨ç¤ºä¾‹ï¼ˆéœ€è¦å®‰è£…: pip install dashscopeï¼‰")
    print("=" * 80)
    
    demo_code = """
# å®‰è£…SDK
# pip install dashscope

import dashscope
import base64
import numpy as np

def stream_tts(text, voice="Cherry", language="Chinese"):
    audio_frames = []
    
    # æµå¼è°ƒç”¨
    responses = dashscope.MultiModalConversation.call(
        api_key=API_KEY,
        model="qwen3-tts-flash",
        text=text,  # å¯ä»¥æ˜¯å®Œæ•´æ–‡æœ¬ï¼ˆä½†ä»æœ‰600å­—ç¬¦é™åˆ¶ï¼‰
        voice=voice,
        stream=True,  # å…³é”®ï¼šå¯ç”¨æµå¼
        language_type=language
    )
    
    # é€å—æ¥æ”¶éŸ³é¢‘
    for chunk in responses:
        try:
            audio_string = chunk.output.audio.data  # base64éŸ³é¢‘
            wav_bytes = base64.b64decode(audio_string)
            audio_np = np.frombuffer(wav_bytes, dtype=np.int16).astype(np.float32) / 32768.0
            audio_frames.append(audio_np)
            
            # å¯ä»¥åœ¨è¿™é‡Œå®æ—¶æ’­æ”¾æ¯ä¸ªchunk
            # play_audio_chunk(audio_np)
            
        except Exception as e:
            print(f"å¤„ç†chunkå¤±è´¥: {e}")
    
    # åˆå¹¶æ‰€æœ‰éŸ³é¢‘
    if audio_frames:
        full_audio = np.concatenate(audio_frames)
        return full_audio
    return None

# ä½¿ç”¨ç¤ºä¾‹
audio = stream_tts("ä½ å¥½ï¼Œè¿™æ˜¯æµ‹è¯•æ–‡æœ¬", voice="Cherry")
"""
    
    print(demo_code)


if __name__ == "__main__":
    # æµ‹è¯•é•¿æ–‡æœ¬åˆ†ç‰‡å’ŒAPIè°ƒç”¨
    test_long_text_processing()
    
    # æ˜¾ç¤ºæµå¼APIç¤ºä¾‹
    test_stream_api_demo()
    
    print("\nğŸ’¡ ç»“è®º:")
    print("   1. å½“å‰çš„TextChunkerä¿®å¤åï¼Œåˆ†ç‰‡é€»è¾‘æ­£ç¡®")
    print("   2. æµå¼APIå¯ä»¥æ”¹å–„ç”¨æˆ·ä½“éªŒï¼Œä½†ä»éœ€åˆ†ç‰‡å¤„ç†")
    print("   3. 600å­—ç¬¦é™åˆ¶æ˜¯æ¨¡å‹æœ¬èº«çš„é™åˆ¶ï¼Œæµå¼å’Œéæµå¼éƒ½ä¸€æ ·")
    print("   4. v1.4å¯ä»¥è€ƒè™‘æµå¼APIï¼Œå®ç°è¾¹ç”Ÿæˆè¾¹æ’­æ”¾")

